![](https://user-gold-cdn.xitu.io/2020/4/4/17145739de13026c?w=900&h=383&f=png&s=32332)

> èŠåˆ°è¿ç»´ï¼Œå¾ˆé•¿ä¸€æ®µæ—¶é—´æˆ‘è§‰å¾—è·Ÿå‰ç«¯å°±æ˜¯æ¯«æ— å…³è”çš„ç©æ„ï¼Œåº”è¯¥è¯´åŠæ¯›é’±å…³ç³»éƒ½æœ¨ã€‚ä½†éšç€å‰ç«¯å·¥ç¨‹åŒ–çš„å‘å±•ï¼Œå‰ç«¯åŸºæœ¬è¿ç»´éƒ¨ç½²ç›¸å…³çŸ¥è¯†ç”šè‡³ä¹Ÿé€æ­¥è¢«é‡è§†ï¼Œå¦‚æœä½ å…¬å¸çš„è¿ç»´éƒ¨é—¨å¾ˆå¼ºå¤§ï¼Œé‚£ä¹ˆä½ ä¹Ÿå¯ä»¥å®Œå…¨å¿½ç•¥è¿ç»´ç›¸å…³çš„ã€‚åªæ˜¯æ ‘é…±è§‰å¾—ï¼Œå¦‚æœä½ æƒ³æ›´å¤šäº†è§£å‰ç«¯æ¶æ„ï¼Œè¿˜æ˜¯éœ€è¦å…·å¤‡ä¸€å®šçš„è¿ç»´ç›¸å…³çŸ¥è¯†å‚¨å¤‡ã€‚å½“ç„¶ï¼Œç°åœ¨äº‘å‚å•†éƒ½æƒ³åº”æ¨å‡ºè‡ªå·±çš„ServerlessæœåŠ¡(ä¸‹ä¸€ç¯‡ä¼šè®²ï½)ï¼Œå·ç§°è®©å‰ç«¯æ›´ä¸“æ³¨ä¸šåŠ¡çš„å¼€å‘ï¼Œè€Œä¸ç”¨æ‹…å¿ƒåº•å±‚åº”ç”¨çš„éƒ¨ç½²å’Œç»´æŠ¤ï¼Œå¯¹å¼€å‘è€…è€Œè¨€å¯ä»¥æ›´å¤šèšç„¦åˆ°ä¸šåŠ¡é¢†åŸŸçš„å¼€å‘ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥å»ç©ç©




![](https://user-gold-cdn.xitu.io/2020/4/8/17158b034ed09212?w=1074&h=584&f=png&s=39535)


### 1.npm
> npm æ˜¯ Node.js å®˜æ–¹æä¾›çš„åŒ…ç®¡ç†å·¥å…·ï¼Œä¸»è¦ç”¨æ¥ç®¡ç†é¡¹ç›®ä¾èµ–ï¼Œå‘å¸ƒç­‰ç­‰ï¼Œä¸‹é¢ä»‹ç»å‡ ä¸ªæ¯”è¾ƒå¸¸è§çš„éƒ¨ç½²åº”ç”¨åœºæ™¯ï¼Œå¸¸ç”¨çš„npmå‘½ä»¤è¿™é‡Œä¸ä½œä»‹ç»äº†

#### 1.1 nrm

> nrm(npm registry manager )æ˜¯npmçš„é•œåƒæºç®¡ç†å·¥å…·ï¼Œå› ä¸ºnpmé»˜è®¤å»ºç«‹çš„é“¾æ¥è®¿é—®çš„æ˜¯å›½å¤–çš„èµ„æºï¼Œè®¿é—®é€Ÿåº¦è¾ƒæ…¢ï¼Œä½¿ç”¨è¿™ä¸ªå°±å¯ä»¥å¿«é€Ÿåœ°åœ¨ npm æºé—´åˆ‡

- å¦‚ä½•å®‰è£…

```
npm install -g nrm 
```

- æŸ¥çœ‹å¯é€‰çš„èµ„æº

```
nrm ls   

*npm ---- https://registry.npmjs.org/

cnpm --- http://r.cnpmjs.org/

taobao - http://registry.npm.taobao.org/

eu ----- http://registry.npmjs.eu/
...
```
- æ·»åŠ ç§æœ‰ä»“åº“é“¾æ¥
```
nrm add name http://registry.npm.tree.com/  # ç§æœ‰ä»“åº“é“¾æ¥
nrm use name # ä½¿ç”¨æœ¬å€çš„é•œåƒåœ°å€    
```

nrm æ›´å¤šç”¨äºå¦‚æœå…¬å¸å†…ç½‘éƒ¨ç½²äº†ç§æœ‰ä»“åº“ï¼Œä¹Ÿå°±æ˜¯æ–¹ä¾¿ç”¨nrmä½œæ¥æºåˆ‡æ¢ï¼Œä¹Ÿæœ‰ç›Šäºä¾èµ–çš„ç‰ˆæœ¬ç®¡ç†ï¼Œå¦‚æœä½ æƒ³æ­å»ºè‡ªå·±çš„ç§æœ‰ä»“åº“ï¼Œå¯ä»¥ä½¿ç”¨verdaccioï¼Œå¯ä»¥çœ‹è¿™ä¸ªå…·ä½“çš„æ•™ç¨‹ [ç‚¹æˆ‘ğŸ‘‡](http://auan.cn/internet/2010.html)

#### 1.2 å‘å¸ƒnpmåŒ…
> å½“æˆ‘ä»¬æƒ³å‘å¸ƒä¸€ä¸ªnpmåŒ…ï¼Œéœ€è¦å®Œæˆä»€ä¹ˆæ ·çš„æµç¨‹å‘¢ï¼Ÿ

- å…ˆæ³¨å†Œnpmè´¦å· [ğŸ”—](https://www.npmjs.com/login)
- é…ç½®package.json
```
{
  "name": "kutil",
  "version": "1.0.0", #ç‰ˆæœ¬åç§°
  "scripts":[], # å¯æ‰§è¡Œçš„è„šæœ¬å‘½ä»¤
  "repository": "https://github.com/xxx/xxx.git", #githubä»“åº“åœ°å€
  "author": "tree <shuxin_liu@kingdee.com>", #ä½œè€…
  "description": "å·¥å…·åŒ…â€œ, #åŒ…çš„è¯´æ˜
  "keywords": [
    "utils",
  ]
}
```
- é…ç½®æ‰“åŒ…æœºåˆ¶
> å¦‚æœæ˜¯å·¥å…·ç±»æ‰“åŒ…ï¼Œæ¨èä½¿ç”¨rollupï¼Œwebpackæ¯”è¾ƒé€‚åˆæ‰“åŒ…ä¸€äº›åº”ç”¨ï¼Œä¾‹å¦‚SPAæˆ–è€…åŒæ„é¡¹ç›®

- æ·»åŠ å•å…ƒæµ‹è¯•
> ä¼˜è´¨çš„å¼€æºåŒ…ï¼Œéƒ½æœ‰å•å…ƒæµ‹è¯•æ¨¡å—ï¼Œæ¥ä¿è¯åŒ…çš„ç¨³å®šæ€§å’Œä»£ç è´¨é‡ï¼Œå¸¸è§ä¼šæœ‰build-passingçš„æ ‡è®°ï¼Œæœ‰å…´è¶£çš„ç«¥é‹å¯ä»¥é˜…è¯»æ ‘é…±ä¹‹å‰å†™çš„[å‰ç«¯å•å…ƒæµ‹è¯•é‚£äº›äº‹](https://juejin.im/post/5e2405146fb9a02fea37366c)

- å¼€å‘æ–‡æ¡£readme.me
> readmeæ–¹ä¾¿å¼€å‘è€…å¿«é€Ÿç†Ÿæ‚‰ï¼ŒåŒ…æ‹¬å…·ä½“çš„Apiä»‹ç»ã€ä½¿ç”¨ä¾‹å­ã€é¡¹ç›®ä»‹ç»ç­‰ç­‰ï¼Œè¿˜å¯ä»¥åŠ å…¥åŒ…æ‹¬å•å…ƒæµ‹è¯•è¦†ç›–ç‡ã€ä¸‹è½½é‡ã€è¯ä¹¦ç­‰ç­‰

æœ€åå®Œæˆä¸Šé¢ä¸€ç³»åˆ—æ“ä½œä¹‹åï¼Œåˆ°äº†æœ€ç»ˆçš„å‘å¸ƒç¯èŠ‚
```
npm login # ç™»å½•ä½ ä¸Šé¢æ³¨å†Œçš„npmè´¦å·

npm publish # ç™»å½•æˆåŠŸåï¼Œæ‰§è¡Œå‘å¸ƒå‘½ä»¤

+ kutil@1.0.0 # å‘å¸ƒæˆåŠŸæ˜¾ç¤ºnpmæŠ¥ååŠåŒ…çš„ç‰ˆæœ¬å·
```

### 2. jenkins
> jenkinsä½œä¸ºä¸€ä¸ªå¯æ‰©å±•çš„è‡ªåŠ¨åŒ–æœåŠ¡å™¨ï¼Œå¯ä»¥ç”¨ä½œç®€å•çš„ CI æœåŠ¡å™¨ï¼Œå…·æœ‰è‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²ç­‰åŠŸèƒ½ï¼Œç®€è€Œè¨€ä¹‹ï¼Œjenkinså¯ä»¥æ–¹ä¾¿æˆ‘ä»¬æ—¥å¸¸çš„å‰ç«¯é¡¹ç›®ç‰ˆæœ¬æ›´æ–°è¿­ä»£ï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®ƒè‡ªåŠ¨åŒ–å®Œæˆä¸€ç³»åˆ—çš„æ“ä½œåŒ…æ‹¬ï¼šç¼–è¯‘æ‰“åŒ…å…ƒæµ‹è¯•ã€ä»£ç æ‰«æç­‰ï¼Œå®˜æ–¹æ–‡æ¡£ 

#### 2.1 å¦‚ä½•å®‰è£…

- ä¸‹è½½ Jenkins.

- æ‰“å¼€ç»ˆç«¯è¿›å…¥åˆ°ä¸‹è½½ç›®å½•.

- è¿è¡Œå‘½ä»¤ ```java -jar jenkins.war --httpPort=8080.```

- æ‰“å¼€æµè§ˆå™¨è¿›å…¥é“¾æ¥ http://localhost:8080.

- æŒ‰ç…§è¯´æ˜å®Œæˆå®‰è£….

è¯¦ç»†æµç¨‹å›¾å¯å‚è€ƒ [Jenkins+github å‰ç«¯è‡ªåŠ¨åŒ–éƒ¨ç½²](https://segmentfault.com/a/1190000010200161)

#### 2.2 é…åˆå‰ç«¯é¡¹ç›®è‡ªåŠ¨åŒ–éƒ¨ç½²

> è¿™é‡Œä¸»è¦ä»‹ç»jenkinsæµæ°´çº¿é…ç½®çš„ä½¿ç”¨ï¼Œæµæ°´çº¿çš„ä»£ç å®šä¹‰äº†æ•´ä¸ªçš„æ„å»ºè¿‡ç¨‹, ä»–é€šå¸¸åŒ…æ‹¬æ„å»º, æµ‹è¯•å’Œäº¤ä»˜åº”ç”¨ç¨‹åºçš„é˜¶æ®µï¼Œä¸‹é¢æ˜¯è·¯å¾„å’Œä»“åº“çš„é…ç½®

![](https://user-gold-cdn.xitu.io/2020/4/8/17157978871902ee?w=1195&h=765&f=png&s=94518)

å›¾ç‰‡ç›¸å…³é…ç½®å¦‚ä¸‹ï¼š

- SCM:é€‰æ‹©gitæˆ–è€…svnä½œä¸ºä»£ç è§¦å‘å™¨
- è„šæœ¬è·¯å¾„ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºjenkinsfileæ¥ç¼–å†™æµæ°´çº¿

ä¸‹é¢ä»‹ç»ä¸€ä¸ªç®€å•ç‰ˆçš„jenkinsfileçš„æµæ°´çº¿ä»»åŠ¡å†™æ³•ï¼Œå®Œæˆæ•´ä¸ªå‰ç«¯å·¥ç¨‹åŒ–éƒ¨ç½²æ¶‰åŠçš„ç¼–è¯‘æ‰“åŒ…ã€é™æ€æ‰«æã€å•å…ƒæµ‹è¯•ç­‰ç¯èŠ‚
```
def gitUrl = "http://gitlab.****.com/shc/****.git"//GITå…¥å£ï¼ˆéšä¸åŒå·¥ç¨‹æ”¹å˜ï¼‰
def gitCred = "***-***-4f00-a926-1848b670d97b"    //GIT èº«ä»½å‡­æ®
if ("DEV" == buildType) {
    buildScript = "build_development"
    try {
        node('k8s') {
            stage('ä¸‹æ‹‰æºç ') {
                   checkout([$class: 'GitSCM', branches: [[name: '*/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: "${gitCred}", url: "${gitUrl}"]]])
                 #å¯ç”±ç‰‡æ®µç”Ÿæˆå™¨ç”Ÿæˆï¼Œé€‰æ‹©ç¤ºä¾‹æ­¥éª¤ â€œcheckout:Check out from version controlâ€ï¼Œç”Ÿæˆæµæ°´çº¿è„šæœ¬è·å–
            }
            checkStatus('ä¸‹æ‹‰æºç ')
            stage('ä»£ç æ„å»ºç¼–è¯‘') {
                sh "yarn run ${buildScript}"
            }
            checkStatus('ä»£ç æ„å»ºç¼–è¯‘')
            stage('ä»£ç é™æ€æ‰«æ') {
                sh 'yarn run lint'
            }
            checkStatus('ä»£ç é™æ€æ‰«æ')
            stage('å•å…ƒæµ‹è¯•') {
                 sh 'yarn run unit'
            }
            checkStatus('å•å…ƒæµ‹è¯•')
        }
    } catch(Exception e) {
       
    }
} 
```
å®Œæˆåï¼Œå³å¯æ„å»ºé¡¹ç›®ï¼Œåˆ†é˜¶æ®µå®Œæˆï¼Œé¦–å…ˆæ˜¯ä¸‹æ‹‰æºç ã€ä»£ç æ„å»ºç¼–è¯‘ã€ä»£ç æ‰«æç­‰ç­‰ï¼Œæ‰€æœ‰ç¯èŠ‚æˆåŠŸæ‰ç®—è‡ªåŠ¨åŒ–éƒ¨ç½²æˆåŠŸï¼Œå¦‚ä¸‹æ‰€ç¤º

![](https://user-gold-cdn.xitu.io/2020/4/8/1715853f1a856328?w=1407&h=589&f=png&s=129671)

### 3.Docker
> Dockeræ˜¯ä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒå®¹å™¨,å¯ä»¥å°†å¼€å‘ç¯å¢ƒã€ä»£ç ã€é…ç½®æ–‡ä»¶ç­‰ä¸€å¹¶æ‰“åŒ…åˆ°è¿™ä¸ªå®¹å™¨ä¸­,æœ€åå‘å¸ƒåº”ç”¨

#### 3.1 å¦‚ä½•ä½¿ç”¨
> é€šè¿‡å°†éƒ¨ç½²çš„æ“ä½œé›†ä¸­æˆä¸€ä¸ªéƒ¨ç½²è„šæœ¬å®Œæˆä¼ ç»Ÿçš„éƒ¨ç½²æµç¨‹ï¼Œé€šè¿‡åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œdockerå®¹å™¨æ¥è¿è¡Œå‰ç«¯åº”ç”¨

å¦‚ä½•å®‰è£…

```
yum install docker-ce
```

é¡¹ç›®ç›®å½•ï¼Œéƒ¨ç½²é¡¹ç›®éœ€è¦å‡†å¤‡Dockerfileå’Œnginx.conf(å¦‚æœnginxä¸ä½œå®šåˆ¶åŒ–ï¼Œå¯ä»¥ç›´æ¥ç”¨å®˜æ–¹é•œåƒ)


![](https://user-gold-cdn.xitu.io/2020/4/8/17158593bd67c238?w=511&h=275&f=png&s=112508)

#### 3.2 Dockerfile é…ç½®

> dockerfileæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶,ç”¨æ¥è®©docker buildå‘½ä»¤æ¸…æ¥šè¿è¡Œé‚£äº›æ“ä½œï¼Œåˆ›å»ºdockerfileå¹¶ç¼–å†™ç›¸å…³é…ç½®

```
FROM node:latest as builder 
WORKDIR /app
COPY package.json 
RUN npm install   
COPY . .
RUN npm run build


FROM nginx:latest
COPY nginx.conf /etc/nginx
COPY --from=builder /app/dist  /usr/share/nginx/html

//ps: æ¯ä¸€ä¸ªæŒ‡ä»¤çš„å‰ç¼€éƒ½å¿…é¡»æ˜¯å¤§å†™çš„ã€‚

```

- ADDå’ŒCOPYï¼š   å°†æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ°Dockerfileæ„å»ºçš„é•œåƒä¸­
- EXPOSEï¼š  æŒ‡å®šè¿è¡Œè¯¥é•œåƒçš„å®¹å™¨ä½¿ç”¨çš„ç«¯å£ï¼Œå¯ä»¥æ˜¯å¤šä¸ªã€‚
- RUN ï¼š æŒ‡ä»¤å‘Šè¯‰docker åœ¨é•œåƒå†…æ‰§è¡Œå‘½ä»¤
- FROM ï¼šé€šè¿‡FROMæŒ‡å®šçš„é•œåƒåç§°ï¼Œè¿™ä¸ªé•œåƒç§°ä¹‹ä¸ºåŸºç¡€é•œåƒï¼Œå¿…é¡»ä½äºç¬¬ä¸€æ¡éæ³¨é‡ŠæŒ‡ä»¤
- WORKDIRï¼š  åœ¨å®¹å™¨å†…éƒ¨è®¾ç½®å·¥ä½œç›®å½•

Nginx.conf é…ç½®å¦‚ä¸‹
```
events {
    worker_connections  1024;
}
http{
    server {
        listen       80;
        server_name  localhost;
        location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
        }   
    }
}
```
åˆ›å»ºæ–‡ä»¶å¹¶ç¼–å†™åï¼Œç”¨dockeråˆ›å»ºé•œåƒ


#### 3.3 å¦‚ä½•åˆ›å»ºé•œåƒ

> ä½¿ç”¨å½“å‰ç›®å½•çš„ Dockerfile åˆ›å»ºé•œåƒï¼Œæ ‡ç­¾ä¸º frontend

```
docker build -t frontend .
```
- -t ï¼šæŒ‡å®šè¦åˆ›å»ºçš„ç›®æ ‡é•œåƒ
- . ï¼šDockerfile æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œå¯ä»¥æŒ‡å®šDockerfile çš„ç»å¯¹è·¯å¾„

![](https://user-gold-cdn.xitu.io/2020/4/8/171585beb75aeece?w=621&h=294&f=png&s=84767)


![](https://user-gold-cdn.xitu.io/2020/4/8/171585c0a9591c52?w=627&h=220&f=png&s=64759)

é•œåƒæˆåŠŸç”Ÿæˆ

#### 3.4 æŸ¥çœ‹é•œåƒ

```
docker image ls | grep frontend
```

![](https://user-gold-cdn.xitu.io/2020/4/8/171585ce9774f38d?w=634&h=39&f=png&s=22026)

å‡ºç°ç»“æœåˆ™åº”ç”¨é•œåƒ frontend æˆåŠŸåˆ›å»º,ç„¶åæˆ‘ä»¬åŸºäºè¯¥é•œåƒå¯åŠ¨ä¸€ä¸ªDockerå®¹å™¨

#### 4.5 å¦‚ä½•å¯åŠ¨

> ä½¿ç”¨dockeré•œåƒfrontend:latestä»¥æŒ‡å®š80ç«¯å£æ˜ å°„æ¨¡å¼å¯åŠ¨å®¹å™¨,å¹¶å°†å®¹å™¨å‘½åä¸ºfrontend

```
docker run --name frontend -p 80:80 frontend:latest
```

- -p: æŒ‡å®šç«¯å£æ˜ å°„ï¼Œæ ¼å¼ä¸ºï¼šä¸»æœº(å®¿ä¸»)ç«¯å£:å®¹å™¨ç«¯å£ å°†å®¿ä¸»çš„80ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„80ç«¯å£
- -name: ä¸ºå®¹å™¨æŒ‡å®šä¸€ä¸ªåç§°ï¼›

å®Œæˆ docker éƒ¨ç½²

dockerä¹Ÿå¯ä»¥é›†æˆåˆ°ä¸Šä¸€èŠ‚è®²çš„jenkinsè‡ªåŠ¨åŒ–éƒ¨ç½²æµæ°´çº¿ä¸­å»

```
  stage('éƒ¨ç½²åˆ°å¼€å‘è”è°ƒç¯å¢ƒ') {
                echo "auto deploy to test environment"
                sh "docker build -t frontend ."
                sh "docker run --name frontend -p 80:80 frontend:latest"
  }
```

### 4.PM2
> PM2æ˜¯nodeè¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥ç®€åŒ–å¾ˆå¤šnodeåº”ç”¨ç®¡ä¸­ç¹çä»»åŠ¡ï¼Œæ˜¯Nodejsåº”ç”¨ç¨‹åºå®ˆæŠ¤è¿›ç¨‹å¿…ä¸å¯å°‘çš„é€‰æ‹©ï¼Œæ–¹ä¾¿ç®¡ç†åŸºäºnodejså¹³å°ä¸‹èƒ½å¤Ÿæœ‰ç‹¬ç«‹è¿è¡Œè®¿é—®çš„webæœåŠ¡ï¼Œå¦‚nextjsã€expressã€koaç­‰å‰ç«¯åº”ç”¨

#### 4.1 å¸¸è§çš„åº”ç”¨åœºæ™¯

- éƒ¨ç½²node koa2 æˆ– express é¡¹ç›®åº”ç”¨
- éƒ¨ç½² å‰ç«¯SSRï¼ˆåç«¯æ¸²æŸ“ï¼‰åº”ç”¨ï¼Œå¦‚nuxt.jsï¼ˆVueï¼‰å’Œ next.js(React)ç­‰æ„å»ºæœåŠ¡ç«¯æ¸²æŸ“åº”ç”¨æ¡†æ¶

####  4.2 å¦‚ä½•ä½¿ç”¨

- å®‰è£… ï¼š``` npm install -g pm2 ```
- å¯åŠ¨nodeé¡¹ç›® : ```pm2 start app.js æˆ–è€… pm2 start bin/www```
- åœæ­¢pm2æœåŠ¡ï¼š```pm2 stop bin/www```
- åœæ­¢æ‰€æœ‰pm2æœåŠ¡: ```stop all```
- é‡å¯pm2æœåŠ¡: ```pm2 restart  bin/www```
- pm2æ‰€æœ‰è¿›ç¨‹ä¿¡æ¯ï¼š```pm2 list```

å¯åŠ¨åå¦‚ä¸‹æ‰€ç¤º
![](https://user-gold-cdn.xitu.io/2020/4/8/1715876dfccea10c?w=1428&h=312&f=png&s=43094)

#### 4.3 é«˜é˜¶åº”ç”¨
> åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ªprocesses.json

```
{
 #appsæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸€ä¸ªæ•°ç»„æˆå‘˜å°±æ˜¯å¯¹åº”ä¸€ä¸ªpm2ä¸­è¿è¡Œçš„åº”ç”¨
  "apps": [{
    "name": "app",  #åç§°
    "script": "./", #ç¨‹åºå…¥å£
    "cwd": "./",           #åº”ç”¨ç¨‹åºæ‰€åœ¨çš„ç›®å½•
    "error_file": "./logs/err.log",#é”™è¯¯è¾“å‡ºæ—¥å¿—
    "log_date_format": "YYYY-MM-DD HH:mm Z" #æ—¥æœŸæ ¼å¼
  }]
}
```
ç»“åˆpackjsonè„šæœ¬å‘½ä»¤ï¼Œå¯ä»¥ç”¨processesæ¥ç®¡ç†å¤šåº”ç”¨
```
"script":{
    "pm2":"pm2 start processes.json"
}
```

æ›´å¤šå‘½ä»¤å’Œé…ç½®ä¿¡æ¯æŸ¥çœ‹ [pm2æ–‡æ¡£](https://www.npmjs.com/package/pm2)

### 5.Nginx

> Nginxå®ƒæ—¢å¯ä»¥ä½œä¸º Web æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè´Ÿè½½å‡è¡¡æœåŠ¡å™¨ï¼Œå…·å¤‡é«˜æ€§èƒ½ã€é«˜å¹¶å‘è¿æ¥ç­‰

#### 5.1 å‰ç«¯Nginxé‚£äº›äº‹

![](https://user-gold-cdn.xitu.io/2020/4/10/17161fa7e059271b?w=1280&h=715&f=png&s=162348)

è¯¦ç»†ä¿¡æ¯è¯·çœ‹ä¹‹å‰æ¢³ç†çš„[å‰ç«¯Nginxé‚£äº›äº‹](https://juejin.im/post/5e7ad2455188255e2c7256ac)

#### 5.2 è¡¥å……

- ç°åº¦å‘å¸ƒ

> ç°åº¦å‘å¸ƒå³æ˜¯è®©ä¸€éƒ¨åˆ†äººç»§ç»­ç”¨æ—§ç‰ˆæœ¬çš„äº§å“Aï¼Œç„¶åä¸€éƒ¨åˆ†ç”¨æˆ·å¼€å§‹ç”¨æ–°ç‰ˆæœ¬ç‰¹å¾çš„äº§å“Bï¼Œå¦‚æœç”¨æˆ·å¯¹Bæ²¡æœ‰ä»€ä¹ˆé—®é¢˜åé¦ˆï¼Œåˆ™é€æ­¥æ‰©å¤§èŒƒå›´ã€‚ä¸€æ–¹é¢å¯ä»¥ä¿è¯æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šï¼Œè€Œä¸”åœ¨åˆå§‹ç°åº¦çš„æ—¶å€™å°±å¯ä»¥å‘ç°ã€è°ƒæ•´é—®é¢˜ï¼Œä»¥ä¿è¯å…¶å½±å“åº¦

ä¼ ç»Ÿçš„ç°åº¦æ˜¯é€šè¿‡Nginxåˆ†å‘æµé‡åˆ°æœåŠ¡å™¨ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹ç®€å•çš„ç°åº¦è§„åˆ™é…ç½®ï¼Œé€šè¿‡åœ¨nginxé‡Œé¢é…ç½®è·¯ç”±è§„åˆ™å°±å¥½ï¼Œå¦‚æœæ˜¯è§„åˆ™å¤æ‚çš„è¯,å¯ä»¥ç»“åˆnginx+lua åšä¸€äº›äº›ç°åº¦çš„ä¸šåŠ¡é€»è¾‘

1.æ ¹æ®Cookieå®ç°ç°åº¦å‘å¸ƒ
> é€šè¿‡è·å–cookieè®¾ç½®çš„ç‰ˆæœ¬å·æ¥åŒºåˆ†
```
upstream test1 {
    server 192.168.0.1:8080 max_fails=1 fail_timeout=60;
}

upstream default {
    server 192.168.0.0:8080 max_fails=1 fail_timeout=60;
}

server {
  listen 80;
  server_name  www.****.com;
  set $group "default";
    if ($http_cookie ~* "version=V1"){
        set $group test1;
    }

  location / {                       
    proxy_pass http://$group;
    proxy_set_header   Host             $host;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    index  index.html index.htm;
  }
 }
```
2. æ ¹æ®IPå®ç°ç°åº¦å‘å¸ƒ
> é€šè¿‡å†…å¤–ç½‘IPæ¥åŒºåˆ†
```
upstream test1 {
    server 192.168.0.1:8080 max_fails=1 fail_timeout=60;
}

upstream default {
    server 192.168.0.0:8080 max_fails=1 fail_timeout=60;
}

server {
  listen 80;
  server_name  www.xxx.com;
  set $group default;
  if ($remote_addr ~ "10.0.0.110") {
      set $group test1;
  }

location / {                       
    proxy_pass http://$group;
    proxy_set_header   Host             $host;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
    index  index.html index.htm;
  }
}
```
